# API 開發 Epic: VirtFlow 設計

## 🧱 Task 1: 需求分析

### ✔️ 驗收標準

- 完成系統架構設計文件

#### 🛠️ Sub-task 1: 現況與困境分析  

- **問題與挑戰**：  
  - 說明目前遇到的主要問題與挑戰  
  - 分析流程中出現的瓶頸與痛點  
- **限制與缺陷**：  
  - 整理現行系統或流程的技術與管理限制  
  - 探討目前操作上的困難與不足

#### 🛠️ Sub-task 2: 現行做法與既有方案評估  

- **現行運作方式**：  
  - 說明目前系統的運作流程與使用的工具  
  - 梳理各個環節的作法與執行方式
- **優缺點評估**：  
  - 分析現有做法的優勢，並指出其成功之處  
  - 紀錄並探討現有方案的不足與改進空間

#### 🛠️ Sub-task 3: 潛在工具與替代方案研究  

- 找出尚未使用但可解決問題的現有工具或技術  
- 評估這些工具是否符合我們需求並進行初步比較  

#### 🛠️ Sub-task 4: 需求收集與分析  

- 與內外部利害關係人進行需求討論  
- 整理需求清單並撰寫需求文件  
- 確認系統範圍與邊界（要做什麼、不做什麼）  
  - 「確認系統範圍與邊界」的意思是要**明確劃定這個系統「要做什麼」以及「不做什麼」**，也就是：
    - ✅ 系統範圍（System Scope）是指：
            這個系統會提供哪些功能、支援哪些角色使用者、要處理哪些資料等等。例如：
      - 使用者可以透過 API 管理虛擬機和租戶
      - 管理員可以查詢資源使用狀況
    - 🚫 系統邊界（System Boundary）是指：
            系統**不處理**哪些事，哪些責任會交給別的系統或手動處理。例如：
      - 系統**不會**負責調度計算（交給 Scheduler Service）
      - 圖形化 UI 不是本階段目標，只提供 API
    - 為什麼重要？
      - 可以避免「範圍膨脹（scope creep）」：大家容易越做越多，最後失控
      - 幫助開發與測試人員明確聚焦：知道該實作什麼、哪些不在任務內
      - 協助利害關係人統一認知：清楚哪些需求會被實現，哪些要列入未來規劃

#### 🛠️ Sub-task 5: 概念與操作定義  

- 定義關鍵術語與名詞（如 Tenant、VM、Quota）
- 建立可操作的規範與標準流程  
  - ✅ 範例一：**定義關鍵術語與名詞**（Concept Definitions）

    | 名詞/術語         | 定義說明 |
    |------------------|----------|
    | **Tenant（租戶）**        | 一個獨立的使用者群組單位，擁有自己的資源配額與權限範圍。系統中的操作多數會根據租戶隔離處理。 |
    | **Baremetal（裸機）**     | 系統中實際存在的實體伺服器，用於提供虛擬化運算資源或直接供應租戶使用。 |
    | **Virtual Machine（VM）**| 由裸機上虛擬化層所創建的虛擬主機單位，是租戶管理的核心資源之一。 |
    | **Resource Quota（資源配額）**| 每個租戶可使用的 CPU、RAM、Disk 等資源限制，避免資源過度使用。 |
    | **API Token**     | 用戶透過登入後取得的認證令牌，用於存取受保護的 API 資源。 |
    | **Object-level Permission（物件層級權限）** | 使用 django-guardian 所設定的權限控制方式，限制特定使用者對某資源的讀寫存取。 |

  - ✅ 範例二：**操作定義與標準流程（Operational Definitions）**
    這部分是定義某些操作「怎麼做」、「什麼情況下算成功」、「有哪些步驟」，例如：
  - 操作流程：**建立一台 VM 的標準流程**
        1. 使用者透過 `/api/v1/vm/create/` 提交建立請求  
        2. 系統驗證：
           - 該使用者是否屬於 VM 所屬的租戶
           - 是否有 `vm.create` 權限
           - 該租戶剩餘資源是否足夠
        3. 若通過，將請求送進資源調度器，並回傳建立中狀態（例如 status: `pending`）  
        4. 建立完成後，回傳包含 VM 詳細資訊的 JSON 資料  
        5. 寫入審計日誌與系統記錄  
  - 定義：**什麼叫「VM 建立成功」？**
    - VM 已進入 `running` 狀態
    - 所需資源都已配置（CPU、RAM、Disk）  
    - 該 VM 在 API 查詢 `/api/v1/vm/{id}/` 時會正確回傳基本資訊與狀態
  - 操作定義：**租戶刪除的前置條件**
    - 該租戶底下的所有 VM 必須先停止或刪除  
    - 租戶名下無未處理的工作（例如資源申請、快照任務）  
    - 該操作只能由具有 `tenant.admin` 權限的使用者執行

#### 🛠️ Sub-task 6: 確立專案目標與預期效益  

- 撰寫專案目標與關鍵成果指標  
- 敘述專案預期帶來的效益  

#### 🛠️ Sub-task 7: 撰寫並審查系統架構設計文件  

- 整合前述分析與研究結果，繪製系統架構圖  
- 撰寫完整設計文件（包含元件、模組與流程）  
- 安排會議，與團隊確認設計方向  

## 🧱 Task 2：系統架構 & 設計

### 🧑‍ 使用者故事（User Story）  

作為系統架構師，我希望能夠完成清晰、可擴展的系統設計方案，包括架構圖、資料模型、API 設計與資料庫規劃，讓後續開發團隊能按圖施工，快速且穩定開發系統。

### ✔️ 驗收標準（Acceptance Criteria）  

- 系統架構圖完成  
- API 設計規範完成，並含錯誤處理定義  
- 資料模型與資料表結構設計完成，包含關聯關係與命名原則  
- 權限模型與資料流程定義清楚（角色分類、權限點、資料流動）  
- 所有內容彙整於設計文件並通過內部審查  

#### 🛠️ Sub-task 1：系統總體架構設計  

- 選擇系統架構風格（Monolith / Microservice / Modular）  
- 選定Tech Stack（Django REST Framework、PostgreSQL、Redis、Docker 等）  
- 劃分模組職責（如：Auth、Resource、Tenant、VM）與相依關係  
- 設計部署架構（如：開發環境 vs 生產環境、docker-compose）  

#### 🛠️ Sub-task 2：核心資料模型與資料表設計  

- 設計核心資料模型（Tenant、VM、Baremetal、Quota 等）  
- 關聯設計（如一對多、多對多、繼承）  
- 設計資料表欄位（含欄位型別、索引、UNIQUE 條件）  
- 撰寫資料模型定義與命名規則文件  

#### 🛠️ Sub-task 3：API 設計與規範  

- 定義 API 架構原則（RESTful / versioning / naming）  
- 設計核心資源的 API endpoints（CRUD、篩選、查詢）  
- 定義請求/回應格式，統一 JSON 結構（含 meta / status / error）
- 設計錯誤處理邏輯（HTTP status 對應、自定義錯誤碼）  
- 撰寫 API 設計說明文件  

#### 🛠️ Sub-task 4：權限控制與資料流設計  

- 定義使用者角色與權限（admin / tenant_user / viewer）  
- 設計物件層級權限（使用 django-guardian）  
- 繪製資料流圖（Data Flow Diagram），說明資料如何跨模組傳遞  
- 撰寫權限模型與資料流程文件  

#### 🛠️ Sub-task 5：設計文件彙整與內部審查  

- 整合所有設計為設計文件  
- 安排技術審查會議
- 修訂文件並定版  
