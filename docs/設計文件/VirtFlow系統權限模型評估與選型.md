# VirtFlow系統權限模型評估與選型

## 1.概述與需求
### 概述
權限管理是系統架構設計中不可或缺的關鍵元素。VirtFlow 系統作為一個負責資源調度與管理的平台，涵蓋虛擬機、實體機、Kubernetes 集群與服務網格等元件，並採用多租戶架構，必須具備精細化的資源存取控制能力。

我們的核心目標是：每位使用者僅能存取並操作分配給自己的資源，而非整個系統中的所有資源。

為實現這項目標，本文將評估現有主流的權限管理模型，分析各自的特性與適用情境，進而選出最符合 VirtFlow 需求的控制機制。我們也將說明相關技術選型的依據與考量。

接下來的內容將依序介紹幾種常見的權限模型，並透過表格進行比較。最終，我們會說明為何選擇 django-guardian 作為實作「物件層級權限控制」的方案，以及其背後的設計思維。

### 需求  
本系統需要管理各種類型的 IT 資源，例如實體機、虛擬機、交換器等，並允許每個資源擁有多個維護者或維護者群組。

- **多種資源類型**：系統需支持不同類型的資源，例如：
  - **實體機（Physical Server）**
  - **虛擬機（Virtual Machine）**
  - **交換器（Network Switch）**
  - **儲存設備（Storage Device）**
- **資源共享模型**：不同類型的資源應該能夠共存於一個統一的系統架構中，並能被不同的維護者管理。  
- **維護者與維護者群組**：
  - 每個資源應可由一個或多個維護者管理。  
  - 維護者可以是個人（單一使用者）或群組（多人組成的管理團隊）。  
  - 群組內的成員可以變更，影響其對應的資源管理權限。  
- **權限管理**：
  - 維護者應擁有對資源的適當操作權限，如讀取、修改、刪除、指派管理員等。  
  - 權限應支援細粒度管理，例如：某些維護者只能查看資源，某些維護者可以變更設定，某些維護者則可移除或轉移資源的管理權限。  
- **審計與記錄**：
  - 所有的資源變更應被記錄，例如：
    - 新增資源
    - 更新資源
    - 移除維護者
    - 變更維護者群組
  - 紀錄應保留變更歷史，以利稽核與追蹤。  

## 2. 權限模型

以下簡要介紹 ACL、RBAC、ReBAC、ABAC 這幾種常見的存取控制 (Access Control) 模型，並說明它們各自的適用場景與優劣。

### 2.1 ACL（Access Control List）
- **核心理念**  
  以「資源為中心」為每個資源維護一張清單 (List)，列出允許哪些使用者 (或群組) 可對此資源進行哪些操作 (如讀、寫、執行)。
- **特徵**  
  - 直觀易懂：只要打開某資源的 ACL，即可知道哪些人能做什麼。  
  - 對大量使用者/資源時，維護成本高：若要對大量資源或使用者配置權限，更新與管理會變得繁雜。  
  - 不易對使用者進行「角色式」分組管理（必須手動列在 ACL 清單內）。

### 2.2 RBAC（Role-Based Access Control）

- **核心概念**  
  RBAC 的設計是透過「角色（Role）」來集中管理權限，再將角色指派給使用者。使用者因此繼承該角色所擁有的所有權限。

- **主要特點**  
  - **管理便利**：企業通常能明確定義角色（如管理者、工程師、財務等），只需將權限綁定在角色上即可，簡化管理流程。  
  - **適合資源類型層級的控制**：標準 RBAC 便於針對「某類資源」設計權限，但**不支援物件層級的細緻控管**，或需要額外機制來補強。  
  - **常見應用場景**：多用於企業後台系統、ERP 或內部管理平台，適合有明確分工結構的環境。

> **常見誤解**：  
> RBAC 並非完全無法支援「物件層級」的權限控管，而是其設計原則並未納入這類需求。若想實現，通常需要進行額外設計，例如：
>
> - 在程式邏輯中檢查使用者角色與物件「owner 欄位」的對應關係。
> - 搭配 ACL（Access Control List）或其他支援物件層級的權限模型。
> - 將資源進行邏輯分組（例如將特定幾台機器歸為一個群組，角色只擁有該群組的權限），這種方式適合資源數量少、分組明確的場景。


### 2.3 ReBAC（Relationship-Based Access Control）
- **核心理念**  
  以「關係 (Relationship)」決定授權，從使用者、資源、甚至使用者間的相互關係判斷是否具有權限。
- **特徵**  
  - 適用於社交平台或需要動態關係鏈的場景：例如「若使用者 A 與 B 是好友關係，就能看對方動態」。  
  - 權限邏輯可能非常複雜，需要管理使用者與資源之間多層關係。  
  - 以圖 (graph) 結構或關係型資料庫中的外鍵鏈結實作，若關係改變，權限即時更動。

### 2.4 ABAC（Attribute-Based Access Control）
- **核心理念**  
  透過「屬性 (Attributes)」和「策略 (Policies)」來決定權限；屬性可以包含使用者屬性（部門、資歷等）、資源屬性（分類、機密等）、環境屬性（時間、位置、裝置型態）等等。
- **特徵**  
  - 非常彈性：條件只要寫進策略中，就能實現多維度判斷。  
  - 實作與維護成本較高：要先定義好各種屬性，並寫好許多策略規則。  
  - 適合龐大且條件多元的環境，如政府或大型企業組織，需因應各式複雜情境。

---

## 3. 權限模型比較表

下表簡要比較上述四種模型的特點：

| 模型   | 控管維度         | 適用場景                          | 優點                                   | 缺點                                     |
|-------|------------------|-----------------------------------|----------------------------------------|------------------------------------------|
| **ACL**  | 資源 + (使用者/群組) | 小規模系統、簡易檔案/物件存取       | 直觀、易於理解                          | 對大量資源/使用者維護不易                |
| **RBAC** | 角色            | 企業內部系統、分工明確的組織       | 角色設定方便、易於維護與審計            | 需額外機制才能支援單一物件層級控管       |
| **ReBAC**| 關係 (Graph)     | 社交平台、需動態/複雜關係的應用     | 關係一變更，權限即時同步                 | 權限檢查邏輯複雜、存取量大時需優化關係查詢 |
| **ABAC** | 屬性 + 策略      | 大規模或多條件策略的組織           | 非常彈性，支援多種屬性組合                | 定義與維護策略較困難、須先建立一整套屬性  |

---

## 4. VirtFlow 的需求與挑戰

本專案 **VirtFlow** 為一個「虛擬資源管理系統」，需要針對以下面向進行權限控管：

1. **多租戶 (Tenant)**：不同租戶間的資源應該隔離。  
2. **多種類資源**：實體機 (Baremetal)、虛擬機 (VirtualMachine)、K8s 叢集 (K8sCluster) 等。  
3. **維護者指派**：想要細緻到可以設定「某個維護者/群組只能編輯他自己負責或屬於他所擁有的機器」。  
4. **操作邏輯複雜度**：有些角色（例如系統管理員）可以跨租戶或跨集群操作；有些角色只能查看特定類別的資源；另外也可能需要在同一類別資源中細分不同物件的存取。

透過以上需求可看出：  
- **RBAC** 可以滿足「角色」區分，但若只停留在角色層級，我們無法直接限定使用者 A 只能操作屬於「A」或「A 所在群組」的實體機。  
- 若要在 RBAC 上擴充，需要將「對單一物件」的擁有權記錄到某張表或以其他方式設計，並在程式層判斷；這就演變成一種變形的 ACL 或自行實作物件層級邏輯。  
- 也可以考慮 ReBAC，但系統暫時沒有像社群平台那種大量複雜關係。  
- ABAC 雖然彈性高，但對本系統來說，管理成本也會較高。

因此，**以 RBAC 為基礎 + 加入對單一物件層級的額外控制**，成為比較合理的選擇。

---

## 5. 我們最終選定的權限模型

### 5.1 選定：RBAC + 物件層級控制

- **RBAC**：我們仍保留角色機制，用來大範圍決定「哪些角色可以操作哪些類型的資源、或者可使用哪些系統功能」。  
- **物件層級控制**：為了進一步指派單一物件（如某台實體機、某個 K8s 叢集）的讀取/編輯權限給指定使用者或群組，我們需要**object-level permissions**。

透過這樣的組合，**使用者 A** 可以同時擁有一個角色（例如 BaremetalOperator），此角色能操作「實體機」資源類型；但在物件層級上，我們會另行指派或限制：A 只能操作「他自己擁有的實體機」或「分配給 A 負責維運的那些機器」。

### 5.2 選擇理由

1. **開發與維護難度適中**：RBAC 架構方便管理角色；而針對需要更細緻的物件控制時，再透過物件層級機制實現。  
2. **支援常見企業場景**：多數企業或專案都已經習慣 RBAC 模型，操作人員與程式碼都易於理解。  
3. **彈性**：可分階段擴充。若未來需要引入更複雜的條件控制（類似 ABAC 方向），也可在此基礎上進行。

---

## 6. 為什麼我們使用 django-guardian

### 6.1 django-guardian 簡介
- **定位**：django-guardian 是 Django 生態圈裡一個專門實現「物件層級權限 (Object Permissions)」的套件。它在 Django 預設的「model-level」權限基礎上，額外提供「個別物件」的許可設定。
- **功能**：
  1. 針對某個具體資料表實例（例如 `Baremetal(id=123)`）設定使用者/群組的「查看、編輯、刪除」等許可權。  
  2. 提供 API 或管理介面，能直接對物件指派或撤銷權限。  
  3. 方便與 Django 的內建 `User`, `Group`, `Permission` 等系統整合。
- **機制**：  
  - 預設採用「or 模型」：只要使用者在任一角色、或透過任一與物件的關聯，獲得了某項權限，就視為擁有該操作能力。  
  - 不支援明確的「Deny 優先」模式：若想要顯式阻擋某位使用者，就需要自行在程式層判斷，或設計更進階的策略。

### 6.2 為何符合我們的需求
1. **物件層級控制**：能準確地限制使用者 A 只能操作自己擁有或被指派的實體機。  
2. **與 Django 相容**：本專案若使用 Django (或類似 Python 後端架構)，與 django-guardian 整合較為平滑。  
3. **降低自研成本**：若完全自己實作物件層級的權限檢查，需要處理許多細節，如資料表結構、快取、查詢優化等，使用現有套件能縮短開發時間。

### 6.3 缺點或考量
1. **缺乏 Deny 的優先模式**：若要精細實現「一旦某處被設置 Deny，即使其他地方有 Grant 也必須拒絕」的功能，就需要自行在程式邏輯中再做檢查。  
2. **權限查詢量**：對於大量物件或大量使用者，需要確保查詢效率； django-guardian 有提供部分快取機制，但仍須針對業務規模做評估。

---

## 7. 其他考量

1. **角色命名與結構**：  
   - 建議先定義好幾個主要角色，如 `Admin`, `Maintainer`, `Operator`, `Viewer` 等，用於指派「一般化」的操作能力。  
   - 其餘更細緻的存取需求再由物件層級權限 (django-guardian) 來解決。

2. **資料表設計**：  
   - 原本在 VirtFlow 裡，可能有 `ResourceMaintainer` 或自定義的維護者關聯表。透過 django-guardian 後，可以保留該資料表做業務紀錄，但實際的存取檢查可以呼叫 django-guardian 的 API 來驗證。  
   - 或者，也能將該關聯表與 guardian 的物件許可權同步更新，達到「一邊記錄維護者/群組責任」與「一邊實現細緻權限控管」的效果。

3. **未來擴充到 ABAC 或 ReBAC**  
   - 若將來需求變動，希望依據更多「屬性」或「關係」來控制資源使用，可以視需求在 django-guardian 或 RBAC 外部，再加一層判斷。  
   - ReBAC 大多應用於社群、多人協作等場景。若未來 VirtFlow 要引入複雜組織結構、階層或跨專案協作，也可考慮串接更強大的權限框架。

---

## 8. 結論

- **各權限模型比較**：ACL 直觀但難於大規模維護；RBAC 角色化管理方便，但原生無法針對單一物件控管；ReBAC 針對關係而生，適用社群平台；ABAC 靈活度高但策略管理複雜。  
- **VirtFlow 的需求**：不僅要基於角色，更要能控制同一資源類型內的不同物件。  
- **最終選擇**：採用 **RBAC + 物件層級控制** 這種混合式模式，並使用 **django-guardian** 來實作物件層級權限。  
- **原因**：  
  1. RBAC 幫助我們輕鬆應付「角色」層級的操作需求。  
  2. django-guardian 補足「單一物件 (Object)」的讀寫管控需求。  
  3. 開發與維護成本較低，與 Django 技術棧相容度高。  

在此方案下，我們能夠指定「使用者 A 只能編輯屬於自己或被指派給自己的實體機」，而不必自行重造輪子去實作物件層級的授權邏輯。雖然缺乏 Deny 優先的模式，但已能大幅滿足現階段的需求，也為將來的權限擴充保留足夠彈性。