# 系統設計評估：以 API Gateway 為唯一入口與中央資料庫的微服務架構

---

## 架構模式與產業對應

本系統採用「API Gateway 為唯一入口 + 中央資料庫」的設計模式，具備高度一致性與低耦合的特性，在大型雲端平台與公有雲中已被廣泛採用。其核心特徵如下：

* 所有使用者與系統請求必須透過 API Gateway 進入。
* API Gateway 同時管理狀態資料庫，是唯一可信任的資料來源（source of truth）。
* 真正的資源操作由分區部署的後端 Service 執行（例如 VM、BM、K8s、Storage 等）。
* 後端 Service 完成後，透過回報機制將狀態更新至 API Gateway。
* 各 Service 間不得直接互相查詢，所有資料查詢行為需透過 API Gateway 進行。

---

## 公有雲對應實例

此架構模式與以下公有雲平台的控制面設計一致(來源: AI)：

| 公有雲平台 | 類似架構元件                            | 說明                               |
| ----- | --------------------------------- | -------------------------------- |
| AWS   | API Gateway + Control Plane       | EC2、EKS 等操作皆透過控制面處理，背後再轉交各服務。    |
| Azure | Azure Resource Manager (ARM)      | 所有資源建立與查詢皆透過 ARM API，統一入口與狀態管理。  |
| GCP   | Cloud Resource Manager + REST API | GCP 採集中式 API 管理所有資源資訊，後端服務不互相耦合。 |

此設計已經過大規模實戰驗證，適合導入於企業內部私有雲或平台即服務（PaaS）場景。

---

## 優缺點評估

### 優點

| 面向      | 說明                                   |
| ------- | ------------------------------------ |
| 解耦性     | 各服務只與 API Gateway 整合，不需了解彼此實作細節。     |
| 介面穩定性   | API Gateway 作為合約提供者，變更後端不影響其他模組。     |
| 權限與日誌管理 | Gateway 作為統一入口，具備審計、RBAC、追蹤等集中優勢。    |
| 資料一致性   | 所有查詢與狀態更新都由中央資料庫管理，不會出現多版本資料來源。      |
| 維運友善    | 可實作 cache、限流、行為審計。 |
| 流量可控    | 系統只需對 API Gateway 進行版本控管與擴展，維護界面成本低。 |

### 缺點 / 成本

| 面向     | 說明                                |
| ------ | --------------------------------- |
| 單點風險   | API Gateway 若故障，整體操作將無法進行。        |
| 壓力集中   | 所有查詢與操作皆經過 Gateway，需具備高可用與良好效能設計。 |
| 初期設計成本 | Gateway 必須定義穩定且通用的介面，早期開發成本較高。    |

---

# 架構模式對照：API Gateway 作為唯一協調者 vs 僅存帳目資料、不轉發
比較「若不採用 API Gateway 為唯一操作中介」與「API 僅負責帳目資料儲存與查詢，後端服務彼此可直接溝通並進行操作」兩種設計模式
| 項目              | 模式一：API Gateway 為唯一協調者（目前設計）              | 模式二：僅帳目記錄中心，後端服務自行溝通            |
| --------------- | ----------------------------------------- | ------------------------------- |
| **服務解耦**        | ✅ 高。服務只依賴 API Gateway，不需彼此知道對方存在。         | ❌ 低。服務間需要了解彼此 API 與資料格式，形成隱性耦合。 |
| **介面穩定性**       | ✅ API 介面由 Gateway 控制，更新集中、可版本控管。          | ❌ 服務 API 若變動，其他依賴服務也需跟著改，風險擴散。  |
| **資料一致性**       | ✅ 單一資料來源與寫入點，狀態同步清楚可追蹤。                   | ⚠️ 各服務需自己處理同步、補償邏輯，容易資料不一致。     |
| **日誌與審計追蹤**     | ✅ 所有操作集中於 API Gateway，可統一記錄與稽核。           | ❌ 日誌分散各 Service，需整合大量來源做審計。     |
| **權限控管**        | ✅ Gateway 可統一實作 RBAC、資源範圍控制。              | ❌ 每個服務需自行實作驗證與授權機制，重工且難一致。      |
| **維運與觀測性**      | ✅ 問題集中可控，易觀測整體系統健康與流量。                    | ❌ 問題排查困難，需進入多個服務才能追查完整操作軌跡。     |
| **擴充與測試成本**     | ✅ 新服務只需整合 Gateway，介面穩定可模擬測試。              | ❌ 每個服務都需模擬其他服務 API，集成測試複雜度上升。   |
| **延伸能力（快取、限流）** | ✅ 可在 Gateway 加入 Cache / Rate Limit 等統一機制。 | ❌ 分散處理成本高，難實作整體策略。              |
| **系統負載分佈**      | ⚠️ Gateway 承擔轉發與狀態操作壓力，需設計 HA 架構與快取。      | ✅ 請求平均分散至各服務，理論上負載分佈較廣。         |
| **開發速度與彈性（短期）** | ⚠️ 初期設計與規劃需投入多，但長期穩定可控。                   | ✅ 初期快速實作簡單，服務可自由互動、快速打通。        |
| **可靠性（中長期）**    | ✅ 介面一致、資料集中，維護與擴充穩定性高。                    | ❌ 隨著服務數量增加，耦合與資料不一致風險上升。        |

---

## ⚠️ 單點故障風險：可接受嗎？

雖然架構上 API Gateway 為單一入口，但此風險在實務上**✅ 是可控且可接受的**。處理方式包括：

1. **API Gateway 高可用部署**

   * 使用 Kubernetes + Ingress Controller + 多副本部署。
   * 加入健康檢查與自動 failover。
   * 重要資料操作應採用 queue + worker 確保 eventual consistency。

2. **資料庫高可用性**

   * 採用主從架構、容錯集群（如 PostgreSQL + Patroni + etcd）或雲端 RDS 解決方案。

3. **查詢快取**

   * 對於靜態與頻繁查詢資料（如 VM 規格、租戶名單），使用 Redis 快取減少查詢壓力。

4. **分區容錯與同步**

   * 若你平台將來部署多區域，可以在每個區部屬自己的 API Gateway + Sync 機制（如 eventual consistency 或 CRDT 同步）

總結而言，API Gateway 的單點風險相對於 Service 間耦合導致的錯誤風險更容易控制與監控。

---

## ❌ 若改為讓各 Service 互相查詢的壞處

不允許 VM Service、Cluster Service 等模組之間互相查詢彼此的 API，是為了以下幾個目的：

| 問題      | 描述                            |
| ------- | ----------------------------- |
| 耦合風險    | 一方變更 API，可能影響多個服務；維護成本高、擴充困難。 |
| 權限控管困難    | 難以集中定義誰能查詢誰（RBAC 分散），容易發生過度授權。       |
| 日誌追蹤缺失  | 無法統一記錄查詢者、時間、查詢內容與結果。         |
| 錯誤擴散風險  | 某服務掛掉導致其他依賴服務一連串錯誤。           |
| 測試與模擬困難 | 各服務間需要模擬彼此 API、增加測試負擔。        |
| **資料不一致**     | 若資料來源分散，各服務自存狀態，會出現不一致問題（尤其是失敗重試場景）    |

解法是統一透過 API Gateway 提供 **版本控管、權限控制、穩定格式的 API**，作為所有查詢與回報的中介層，服務間互不依賴。

---

## ✅ 建議方向

1. **維持現有 API Gateway 中央資料平面設計**，不應讓服務間互查。
* Service 間所有通訊都透過 API Gateway，並標準化查詢與回報格式
2. **強化 Gateway 的 HA、觀測性與彈性擴展能力**，確保效能與穩定性。
3. **建立標準化 API Schema 契約與版本控管流程（如 OpenAPI 3）**，避免破壞相容性。
4. **如查詢量過大，可實作只讀快取機制（例如內建 Cache Layer 或查詢分片）**。
5. **未來可納入 Event Bus / Notification 機制，實現非同步觸發與狀態變更通知，減少輪詢與同步壓力。**
