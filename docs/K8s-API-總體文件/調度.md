## 4. 自動化資源調度

### 4.1 調度目標

- **租戶配額檢查**：當要建立虛擬機或 K8s 叢集時，先檢查對應租戶在指定群組的配額。
- **群組可用資源**：檢查該群組內所有實體機的可用 CPU、記憶體及儲存空間等，找出符合需求且負載最適合的實體機。
- **地理或機櫃條件**（選用）：可以在調度演算法中納入 `Rack`、`region`、`dc` 等屬性，執行更精細的調度。

### 4.2 調度流程

1. **收到建立/擴增需求**  
   - 使用者透過 API 提出建立虛擬機 (VM) 或 K8s 叢集的請求，需指定：
     - 租戶 (Tenant)  
     - 目標群組 (BaremetalGroup)  
     - VM 規格 (若為單純建立 VM) 或叢集版本/外掛 (若為建立 K8s 叢集)  
2. **檢查配額與資源**  
   - 由系統查詢 `BaremetalGroupTenantQuota`，判斷租戶在該群組是否還有足夠配額。  
   - 進一步檢索此群組下所有 `Baremetal` 狀態，篩選出可容納需求規格的實體機清單。  
3. **選擇最適合實體機**  
   - 系統可實作多種策略（例如最小剩餘空間優先、或最大剩餘空間優先等）來找出最合適的 Baremetal。  
4. **分配與建立**  
   - 若找到合適的實體機，系統在資料庫中建立對應的 `VirtualMachine` 或更新對應的 `K8sCluster` 紀錄，並透過外部的 Provision Agent/工具實際執行部署。  
   - 資源使用量同時更新（該實體機與該群組的 available_cpu / memory / storage 皆扣減）。  
5. **回報結果**  
   - 若部署成功，系統回傳成功訊息並更新狀態為 `active`；若調度失敗（無可用資源），系統回報錯誤，提示使用者更換群組或調整需求。
