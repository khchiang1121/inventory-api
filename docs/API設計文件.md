# 專案目標與範圍

# 利害關係人分析

# 需求訪談紀錄

# 功能清單
### 1. 機房資訊管理

| 功能          | 說明                                     |
| ----------- | -------------------------------------- |
| 機房管理        | 管理資料中心位置與基本描述。                         |
| 機櫃管理        | 管理虛擬機房、可用者（使用者）、所屬實體位置與狀態。             |
| 層位管理        | 管理可用狀態、網路設定、層位分組、可用者；支援跨資料中心與機房區域分組。   |
| 機架管理 (Rack) | 建立實體機所屬機架資訊，包括名稱、BGP/AS 編號等，利於網路與空間規劃。 |
- **機架 (Rack)**
  - 針對實體機在資料中心中的實際位置，記錄機架名稱、BGP/AS 編號等網路相關資訊。
  - 有助於大型資料中心中快速定位問題機架或進行網路配置調度。

---

### 2. 實體主機與群組（Bare-metal Hosts & Grouping）

| 功能      | 說明                                    |
| ------- | ------------------------------------- |
| 登錄主機    | 管理平台中的所有實體主機資訊，包含資源、機房位置與狀態。          |
| 分組管理    | 將主機依據地理區域、部門用途進行邏輯分組。                 |
| 資源分配依據  | 所有虛擬機與叢集的部署都可指定部署在哪個主機群組。             |
| 支援查詢與篩選 | 依狀態（運作中、維護中）、可用資源、自訂欄位進行快速查詢。         |
| 機櫃與機架定位 | 追蹤實體主機所屬的資料中心區域、機櫃與單元編號，有助於問題排查與佈線管理。 |
- **實體機 (Baremetal)**
  - 替代舊版系統的 Host，詳細記錄機器名稱、序號、可用資源 (CPU/記憶體/儲存空間) 以及所屬的機架 (Rack) 與群組 (BaremetalGroup)。
  - 可追蹤實體機歸屬的資料中心區域 (region)、機房 (dc)、機櫃位置 (rack & unit) 等資訊，用於跨區部署與運維。

- **實體機群組 (BaremetalGroup)**
  - 依不同維度（例如地理位置或負載）彈性地將多台實體機歸在同一群組。
  - 在系統中，租戶配額通常是以群組維度在做管控。
---

### 3. 虛擬機管理（Virtual Machine Management）

| 功能        | 說明                                           |
| --------- | -------------------------------------------- |
| 建立虛擬機     | 指定租戶、主機、規格、所屬叢集，系統自動分配資源並啟動部署流程。             |
| 啟動虛擬機     | 對已關機的虛擬機進行開機。                                |
| 關閉虛擬機     | 執行安全的關機程序，亦可支援強制關機。                          |
| 重啟虛擬機     | 執行重新啟動流程，保留原本的資源與設定。                         |
| 刪除虛擬機     | 移除虛擬機與資源佔用，可設定是否保留資料磁碟。                      |
| 查看詳細狀態    | 顯示 CPU / 記憶體 / 儲存空間使用狀況與當前狀態（建立中、執行中、停止等）。   |
| 自訂命名規則    | 建立時可依租戶或部門自訂命名邏輯，利於資產追蹤。                     |
| 關聯資源查詢    | 顯示虛擬機所屬的租戶、主機、維護者、K8s 叢集等資訊。                 |
| 查看母版      | 查看目前有的所有母版，在建立虛擬機時會指定母版。                     |
| 虛擬機規格定義   | 支援預先定義 VM 規格（CPU、記憶體、儲存），並標記版本或世代。可供快速建立時選用。 |
| 記錄部署與調度紀錄 | 系統保留每次 VM 建立的調度資訊與資源變動紀錄。                    |
- **虛擬機規格 (VirtualMachineSpecification)**
  - 預先定義常用的 VM 規格 (CPU、記憶體、儲存空間)；可附帶版本或世代編號 (generation) 以利版本區分。
  - 建立新 VM 時可直接選取某個規格，系統將據此分配所需實體資源。

- **虛擬機 (VirtualMachine)**
  - 每個 VM 均有所屬的租戶 (Tenant)、部署在哪台實體機 (Baremetal)、使用哪種規格 (VirtualMachineSpecification) 等。
  - 可進一步標註該 VM 是否隸屬於某個 K8s 叢集，並指定 VM 的角色 (control-plane、worker、management 等)。

---

### 4. Kubernetes 叢集管理（Kubernetes Cluster Management）

平台支援多叢集 Kubernetes 管理，參考 GKE / EKS / OpenShift 設計，具備以下能力：

#### 📦 基本操作

| 功能        | 說明                                  |
| --------- | ----------------------------------- |
| 建立 K8s 叢集 | 選擇租戶與主機群組，系統可根據預設模板或自訂設定建立控制平面與節點群。 |
| 查看叢集資訊    | 顯示叢集名稱、描述、Kubernetes 版本、租戶歸屬、建立時間等。 |
| 調整叢集狀態    | 將叢集標記為「運作中」、「維護中」、「異常」等，利於資源排程與觀測。  |
| 刪除叢集      | 若不再使用，可將叢集與其底層節點完整清除。               |

#### ⚙️ 進階操作（對應公有雲常見能力）

| 功能              | 說明                                                 |
| --------------- | -------------------------------------------------- |
| 升級版本            | 升級控制平面與節點的 Kubernetes 版本，支援滾動升級與自動回滾（未來版本）。        |
| 擴縮節點數量          | 可手動或自動調整節點數（即 VM 數量）以支撐應用負載。                       |
| 節點群組設定          | 支援同一叢集中多組節點設定（不同主機群組、不同 VM 規格）。                    |
| 認證管理整合          | 支援租戶使用憑證（如 kubeconfig）登入叢集（未來支援整合 LDAP/OIDC）。      |
| 網路與儲存資源配置       | 可指定網路插件（如 Cilium）、儲存類型（如 Ceph、NFS）於叢集中使用。          |
| 外掛管理            | 可記錄每個叢集所安裝的 Plugins（名稱、版本、狀態），方便統一管理與維運。           |
| Service Mesh 管理 | 記錄叢集所使用的 Service Mesh 類型、版本與角色（primary/secondary）。 |
| 堡壘機關聯           | 支援與 Bastion VM 建立關聯，提供存取叢集的跳板機資訊管理。                |
| 應用部署入口（未來）      | 可串接 Helm / ArgoCD，讓租戶快速部署應用模板。                     |
| 健康監控（未來）        | 提供叢集節點健康、Pod 分佈、網路流量等即時指標圖表。                       |
- **K8sCluster**
   - 紀錄 K8s 叢集的核心資訊，例如叢集名稱、版本、所屬租戶、狀態 (active / maintenance / offline / error) 等。
   - 與 VM 關聯：在叢集建立過程中，通常需要多台虛擬機做控制平面 (control-plane) 與工作節點 (worker)；系統會將這些 VM 標註為隸屬某 K8sCluster。
- **K8sClusterPlugin**
   - 系統可安裝各種外掛 (Plugins) 到 Kubernetes 叢集上，如網路外掛、監控外掛、儲存外掛等。
   - 能記錄外掛的名稱、版本、狀態 (active/inactive/error)；在管理多叢集且不同外掛版本時尤其重要。
- **BastionClusterAssociation**
   - 針對有堡壘機 (Bastion) 的場景，系統提供此關聯來紀錄「哪台 VM」作為某叢集的堡壘機。
   - 方便在多個叢集都使用同一台堡壘機（或不同堡壘機）的時候，能快速查詢與管理。
- **ServiceMesh**
   - 定義了 Service Mesh 本身的名稱、類型 (cilium / istio / other)、版本與狀態等資訊。
- **K8sClusterToServiceMesh**：將特定的 K8s 叢集綁定到特定 Service Mesh，並可指派該 Mesh 在叢集中的角色 (primary / secondary)。
   - 使得系統能支援多叢集下的 Service Mesh 部署策略，或同時運行多種 Service Mesh 用於測試比較。

---

### 5. 租戶與配額管理（Tenant & Quota Management）

| 功能        | 說明                              |
| --------- | ------------------------------- |
| 建立租戶      | 可依照部門、專案或外部客戶建立獨立資源空間。          |
| 配額限制      | 限制租戶使用的 CPU、記憶體、儲存容量，並可跨主機群組細分。 |
| 查看資源用量    | 一覽租戶已使用與剩餘資源，支援配額告警（未來版本）。      |
| 停用租戶      | 暫停該租戶的所有資源建立與操作行為。              |
| 刪除租戶      | 清除該租戶與其關聯的資源（需先移除所有虛擬機與叢集）。     |
| 支援百分比與絕對值 | 配額可設定為百分比或固定數值，滿足不同規模租戶需求。      |
- **租戶 (Tenant)**
  - 代表系統使用者或部門，系統將針對每個租戶設定不同層級的資源使用權限。
  - 可以同時在多個 `BaremetalGroup` 拥有配額。

- **配額 (BaremetalGroupTenantQuota)**
  - 針對「某租戶在某個實體機群組」的可用資源上限或分配量做紀錄與控管。
  - 支援設定 CPU、記憶體、儲存空間的上限，或者使用百分比 (quota percentage) 的形式，靈活應對不同租戶需求。

---

### 6. 維護者制度（Maintainer & Ownership Management）

| 功能       | 說明                                       |
| -------- | ---------------------------------------- |
| 維護者註冊    | 建立個人維護者資料，含姓名、Email、狀態等。                 |
| 建立維護者群組  | 將多位維護者組成團隊並指定負責人，支援跨部門協作。                |
| 維護者與群組關聯 | 一名維護者可加入多個群組，具多對多關聯性。                    |
| 指派維護責任   | 為實體機、虛擬機、K8s 叢集等資源分配專屬維護人員或群組。           |
| 多型態關聯支援  | 所有資源皆可透過 ResourceMaintainer 多型關聯，設置多人維護。 |
| 查詢責任歸屬   | 快速查詢特定資源的負責人，或查某位人員名下的所有資源。              |
- **維護者 (Maintainer)**
  - 記錄維運人員的基本資訊（姓名、帳號、聯絡方式等）。
  - 系統內的「維運責任歸屬」可以指派給單一維護者。

- **維護者群組 (MaintainerGroup)**
  - 將多位維護者歸為一個群組，利於大型專案或團隊共同維運。
  - 具備群組管理者 (group_manager) 機制，用於設定該群組的主要負責人。
  - 可透過多對多關聯（MaintainerToMaintainerGroup）讓維護者隨時加入或退出群組。

- **資源與維護者的多型關聯 (ResourceMaintainer)**
  - 系統內幾乎所有資源（例如 Baremetal、VirtualMachine、K8sCluster 等）都能透過此機制指派給維護者 (個人) 或維護者群組。
  - 支援在同一個資源上設置多位維運人員或群組，對於具高複雜度的環境維運特別有用。

---

### 7. 群組租戶配額（Quota per Host Group & Tenant）

| 功能     | 說明                                    |
| ------ | ------------------------------------- |
| 配額設定   | 在主機群組層級對租戶設定最大使用比例或資源上限（CPU%、記憶體、磁碟）。 |
| 多層配額控制 | 支援「平台 → 群組 → 租戶」三層配額設計，便於大型企業資源管控。    |
| 可視化查詢  | 展示每個配額配置與實際使用情況，利於資源調整與報表產出。          |
| 調度邏輯整合 | 系統在建立 VM 或 K8s 時會依此配額自動調度至適當的實體機。     |
| 支援動態調整 | 可隨時變更配額，並自動更新所有相關記錄與狀態。               |

---

### 8. 核心 API Gateway 與中央帳務資料庫

| 功能          | 說明                                                                                                       |
| ----------- | -------------------------------------------------------------------------------------------------------- |
| 雲端操作入口      | 本系統 API 作為所有操作（虛擬機、實體機、K8s 叢集）的唯一入口，負責驗證請求、轉發指令至對應後端 Service（如 VM Service / K8s Orchestrator），自身不負責實際操作。 |
| 中央帳務資料庫     | 系統為唯一的資料來源，所有虛擬機、主機、叢集、租戶、維護責任與配額資訊皆保存在此。後端服務（如 VM Service）亦需透過此 API 查詢與回報狀態。                            |
| 跨服務資料存取     | 若任一 Service 需查詢其他模組資料（如 VM Service 查詢租戶配額），皆需透過本 API 提供的 RESTful 介面存取，統一資料來源與存取權限。                       |
| 狀態同步回報      | 實際操作由後端執行後，需透過 API 回報操作結果（成功、失敗、部署中等），系統會更新對應資源狀態與時間戳記。                                                  |
| 操作追蹤與稽核     | 所有請求都可記錄操作來源（使用者 / 系統）、時間、結果與操作對象，便於後續稽核與問題追查。                                                           |
| 錯誤轉譯與統一回應格式 | API 負責將後端錯誤（如資源不足、建立失敗）標準化為平台格式，並提供友善提示給前端或外部系統。                                                         |

---

# 非功能性需求分析



# 使用情境與流程圖
### 5.1 新增與管理維護者

1. **新增個人維護者 (Maintainer)**：管理者在後台輸入該員工姓名、帳號、狀態等，建立一筆維護者紀錄。  
2. **建立維護者群組 (MaintainerGroup)**：設定群組名稱、群組管理者；將若干個維護者 (Maintainer) 加入群組。  
3. **指派資源維運**：在「ResourceMaintainer」中將某台實體機 (Baremetal) 或某個 K8s 叢集指派給個別維護者或維護者群組，後續有任何變動都能追蹤。

### 5.2 建立實體機並指定機架

1. **新增機架 (Rack)**：可預先於系統中創建機架資訊，填寫機架名稱、BGP/AS 編號或任何網路相關資訊。  
2. **建立實體機 (Baremetal)**：系統記錄該機器位於哪個機架、可用資源、序號等；將其歸屬至某個實體機群組 (BaremetalGroup) 中。  
3. **查詢機架資源**：運維人員可在控制介面選擇某個機架以檢視該機架所有實體機的運行狀況及負載統計。

### 5.3 租戶配額設定

1. **建立租戶 (Tenant)**：為某組或部門開通租戶帳號，設定名稱與說明。  
2. **設定群組配額 (BaremetalGroupTenantQuota)**：可對該租戶在特定實體機群組內設定 CPU 百分比、記憶體上限與儲存空間上限。  
3. **動態調整**：若該租戶發展擴大，需要更多配額，可隨時調整數值，並於後台管理介面紀錄更新時間。

### 5.4 建立虛擬機

1. **使用者提交 VM 建立請求**：包含規格 (VirtualMachineSpecification)、目標租戶、目標群組等資訊。  
2. **系統檢查**：系統先檢查租戶在該群組的可用配額，並找到符合需求規格且資源足夠的實體機 (Baremetal)。  
3. **預留並部署**：系統預留資源後透過外部 Provision Agent 建立 VM，若成功則更新 `VirtualMachine` 狀態為 `active`。  
4. **維運指派**：可在 `ResourceMaintainer` 中將此 VM 指派給某位維護者以利後續管理。

### 5.5 建立 Kubernetes 叢集

1. **使用者提交 K8s 叢集建置請求**：包含 Kubernetes 版本、所需的主控制 (control-plane) 節點數、工作 (worker) 節點數等。  
2. **系統自動調度**：針對每個節點需求，依照指定租戶的配額、群組可用量來尋找合適的 `Baremetal` 建立對應的 `VirtualMachine`。  
3. **外掛與 Service Mesh 選擇**：若在建置流程中勾選需要特定外掛 (Plugin) 或 Service Mesh，系統會在 `K8sClusterPlugin` 與 `K8sClusterToServiceMesh` 中增加紀錄。  
4. **部署完成**：K8s 叢集建立完成後，系統標註相關 VM 與叢集關聯；若指定了堡壘機（Bastion VM），則在 `BastionClusterAssociation` 進行關聯紀錄，以利後續維運。



# 介面定義

# 資料模型設計

# 系統架構設計
1. **前端 / API 介面**  
   - 以 Django Rest Framework 或其他 API 框架提供 RESTful 介面，供使用者/管理員進行各類查詢與操作。

2. **核心調度邏輯**  
   - 接收建立虛擬機 / 叢集請求後，負責檢查配額與資源，通過後傳送到後端系統進行部署。

3. **資料存儲與管理**  
   - 所有資源、租戶、維護者與配額等資訊都存放於資料庫；**詳細的資料表結構與設計已在其他文件中定義**。

4. **外部 Provision Agent**  
   - 系統不直接建立虛擬機或佈署叢集，而是將排程後的結果傳遞給獨立的 Provision Agent，藉此執行實際的建置任務。




# 系統邊界與整合點分析

# 錯誤與例外處理


# 風險與限制
技術風險: DRF效能是否不足?
時間風險: 其他 service 是否仰賴先生出第一版?

# 驗收標準定義
第一階段:



# 開發時程與里程碑
第一階段: 完成 Inventory 系統開發 (DB + CRUD)
第二階段: 完成 API 串接模組 (如何轉發與串接後端API)
第三階段: 完成 內部邏輯設計 (資源配額)
第四階段: 完成 組織外部 API (如何組織各API)
第五階段: 完成 前端顯示